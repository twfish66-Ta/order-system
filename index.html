<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é»é¤è¨ˆåƒ¹ç³»çµ±</title>
    <!-- Web App Manifest for offline capabilities -->
    <link rel="manifest" href="data:application/json,{%22name%22:%22é»é¤è¨ˆåƒ¹ç³»çµ±%22,%22short_name%22:%22é»é¤ç³»çµ±%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22#ffffff%22,%22theme_color%22:%22#4A90E2%22}">
    <meta name="theme-color" content="#4A90E2">

    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Chart.js åœ–è¡¨åº« -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- å¼•å…¥ SheetJS (xlsx) ç”¨æ–¼åŒ¯å‡º Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        /* ä½¿ç”¨ Google å­—é«” Inter å’Œ Noto Sans TC */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+TC:wght@400;500;700&display=swap');
        html {
            scroll-behavior: smooth; /* è®“é é¢æ»¾å‹•æ›´å¹³æ»‘ */
        }
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        /* æŒ‰éˆ•é»æ“Šæ™‚çš„å‹•ç•«æ•ˆæœ */
        .btn-press {
            transform: scale(0.95);
            transition: transform 0.1s ease-in-out;
        }
        /* é …ç›®è¢«é¸ä¸­æ™‚çš„æ¨£å¼ */
        .item-selected {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
            background-color: #EBF8FF;
        }
        /* ç¦ç”¨æŒ‰éˆ•çš„æ¨£å¼ */
        .disabled-btn {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #9CA3AF; /* æ›´æ˜é¡¯çš„ç¦ç”¨é¡è‰² */
        }
    </style>
</head>
<body class="bg-gray-100 p-2 sm:p-4">

    <!-- ä¸»å®¹å™¨ -->
    <div class="w-full max-w-6xl mx-auto bg-white rounded-2xl shadow-lg p-3 md:p-6 mb-8">
        
        <!-- ä¸»å…§å®¹å€å¡Š -->
        <div class="w-full pt-6">
            <!-- å•†å“åˆ—è¡¨å®¹å™¨ (Grid ä½ˆå±€) -->
            <div id="items-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3">
                <!-- èœå–®é …ç›®å’Œé€å‡ºè¨‚å–®æŒ‰éˆ•å°‡æœƒè¢«æ’å…¥åˆ°é€™è£¡ -->
            </div>

            <!-- æ§åˆ¶å€å¡Š -->
            <div class="mt-6">
                <!-- ç¸½é‡‘é¡æ–¹æ ¼ -->
                <div class="bg-blue-600 text-white p-4 rounded-lg w-full flex items-center justify-between shadow-lg">
                    <h2 class="text-xl sm:text-2xl font-semibold">ç¸½é‡‘é¡</h2>
                    <span id="total-price" class="text-3xl sm:text-4xl font-bold">NT$ 0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- è¨‚å–®è¨˜éŒ„å€å¡Š -->
    <div id="order-log-section" class="w-full max-w-6xl mx-auto bg-white rounded-2xl shadow-lg p-3 md:p-6 mb-8">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl sm:text-3xl md:text-4xl font-bold text-gray-800">è¨‚å–®è¨˜éŒ„</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-200 text-lg sm:text-xl">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="py-2 px-3 sm:py-3 sm:px-5 border-b text-left text-base sm:text-lg font-semibold text-gray-600">è¨‚å–®ç·¨è™Ÿ</th>
                        <th class="py-2 px-3 sm:py-3 sm:px-5 border-b text-left text-base sm:text-lg font-semibold text-gray-600">å“é …</th>
                        <th class="py-2 px-3 sm:py-3 sm:px-5 border-b text-left text-base sm:text-lg font-semibold text-gray-600">ç¸½é‡‘é¡</th>
                        <th class="py-2 px-3 sm:py-3 sm:px-5 border-b text-left text-base sm:text-lg font-semibold text-gray-600">æ™‚é–“</th>
                    </tr>
                </thead>
                <tbody id="order-log-body">
                    <!-- è¨‚å–®è¨˜éŒ„å°‡æœƒè¢«æ’å…¥åˆ°é€™è£¡ -->
                </tbody>
            </table>
        </div>
        <!-- åˆ†é æ§åˆ¶å™¨ -->
        <div id="pagination-controls" class="mt-4 sm:mt-6 flex justify-center items-center space-x-2 sm:space-x-6">
            <!-- åˆ†é æŒ‰éˆ•å°‡æœƒè¢«æ’å…¥åˆ°é€™è£¡ -->
        </div>
    </div>

    <!-- å•†å“éŠ·å”®ç¸½è¡¨ -->
    <div id="summary-section" class="w-full max-w-6xl mx-auto bg-white rounded-2xl shadow-lg p-3 md:p-6 mb-8">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl sm:text-3xl md:text-4xl font-bold text-gray-800">å•†å“éŠ·å”®ç¸½è¡¨</h2>
            <div class="flex items-center space-x-2">
                 <button id="clear-log-btn" class="bg-red-500 text-white px-4 py-2 sm:px-6 sm:py-3 rounded-lg text-base sm:text-lg font-bold hover:bg-red-600 transition-all">
                    å…¨éƒ¨æ¸…é™¤ä¸¦å‚™ä»½
                </button>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-200 text-lg sm:text-xl" id="sales-summary-table">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="py-2 px-3 sm:py-3 sm:px-5 border-b text-left text-base sm:text-lg font-semibold text-gray-600">å•†å“</th>
                        <th class="py-2 px-3 sm:py-3 sm:px-5 border-b text-left text-base sm:text-lg font-semibold text-gray-600">ç¸½æ•¸é‡</th>
                        <th class="py-2 px-3 sm:py-3 sm:px-5 border-b text-left text-base sm:text-lg font-semibold text-gray-600">ç¸½é‡‘é¡ (NT$)</th>
                    </tr>
                </thead>
                <tbody id="sales-summary-body">
                    <!-- éŠ·å”®ç¸½çµå°‡æœƒè¢«æ’å…¥åˆ°é€™è£¡ -->
                </tbody>
                <tfoot id="sales-summary-footer">
                    <!-- ç•¶æ—¥ç¸½é‡‘é¡å°‡æœƒè¢«æ’å…¥åˆ°é€™è£¡ -->
                </tfoot>
            </table>
        </div>
    </div>

    <!-- çµ±è¨ˆåœ–è¡¨å€å¡Š -->
    <div id="charts-section" class="w-full max-w-6xl mx-auto bg-white rounded-2xl shadow-lg p-3 md:p-6">
        <h2 class="text-2xl sm:text-3xl md:text-4xl font-bold text-gray-800 mb-4 sm:mb-6">éŠ·å”®çµ±è¨ˆåœ–è¡¨</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-8">
            <div>
                <h3 class="text-xl sm:text-2xl font-semibold text-center text-gray-700 mb-2 sm:mb-3">å•†å“éŠ·å”®æ•¸é‡</h3>
                <canvas id="quantityChart"></canvas>
            </div>
            <div>
                <h3 class="text-xl sm:text-2xl font-semibold text-center text-gray-700 mb-2 sm:mb-3">å•†å“éŠ·å”®é‡‘é¡ (NT$)</h3>
                <canvas id="revenueChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="custom-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 sm:p-8 w-full max-w-sm sm:max-w-md mx-4">
            <h3 class="text-xl sm:text-2xl font-bold text-gray-900 mb-4">ç¢ºèªæ“ä½œ</h3>
            <p id="modal-text" class="text-gray-600 mb-6 sm:mb-8 text-lg sm:text-xl">æ‚¨ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è¨‚å–®è¨˜éŒ„å’ŒéŠ·å”®æ•¸æ“šå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚</p>
            <div class="flex justify-end space-x-4">
                <button id="modal-cancel-btn" class="px-4 py-2 sm:px-6 sm:py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 text-lg sm:text-xl">å–æ¶ˆ</button>
                <button id="modal-confirm-btn" class="px-4 py-2 sm:px-6 sm:py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-lg sm:text-xl">ç¢ºå®šæ¸…é™¤</button>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            
            // --- è³‡æ–™å®šç¾© ---
            const menuItems = [
                { id: 2, name: 'è›‹çµ²æ¶¼éºµ', price: 70, emoji: 'ğŸœ' },
                { id: 12, name: 'ç«è…¿æ¶¼éºµ', price: 70, emoji: 'ğŸœ' },
                { id: 3, name: 'ç‡»é›æ¶¼éºµ', price: 80, emoji: 'ğŸœ' },
                { id: 4, name: 'æ¾å‚è‚‰æ¶¼éºµ', price: 90, emoji: 'ğŸœ' },
                { id: 5, name: 'ç‡’è‚‰åˆˆåŒ…', price: 85, emoji: 'ğŸ”' },
                { id: 6, name: 'é´¨è³åˆˆåŒ…', price: 95, emoji: 'ğŸ”' },
                { id: 13, name: 'ç´ é£ŸåˆˆåŒ…', price: 60, emoji: 'ğŸŒ¿' },
                { id: 7, name: 'åŠ è›‹', price: 15, emoji: 'ğŸ¥š' },
                { id: 1, name: 'å†°ç´…èŒ¶', price: 25, emoji: 'ğŸ¥¤' },
                { id: 9, name: 'å†°æ²™', price: 50, emoji: 'ğŸ§' },
                { id: 10, name: 'ç«¹ç‚­æ°´', price: 20, emoji: 'ğŸ’§' },
                { id: 11, name: 'èˆ’è·‘', price: 30, emoji: 'ğŸ¥¤' },
                { id: 15, name: 'ä¸€ä¸²', price: 25, emoji: 'ğŸ¢' },
                { id: 16, name: 'äº”ä¸²', price: 100, emoji: 'ğŸ¢' },
                { id: 17, name: 'èœé ­', price: 15, emoji: 'ğŸ¥¬' }
            ];
            let orderCounter = 1;
            let salesData = {};
            let allOrders = []; // ç”¨æ–¼å„²å­˜æ‰€æœ‰è¨‚å–®
            let currentPage = 1;
            const ordersPerPage = 10;
            let quantityChartInstance = null;
            let revenueChartInstance = null;

            // --- å…ƒç´ é¸å– ---
            const itemsContainer = document.getElementById('items-container');
            const totalPriceEl = document.getElementById('total-price');
            const orderLogBody = document.getElementById('order-log-body');
            const paginationControls = document.getElementById('pagination-controls');
            const clearLogBtn = document.getElementById('clear-log-btn');
            const quantityChartCtx = document.getElementById('quantityChart').getContext('2d');
            const revenueChartCtx = document.getElementById('revenueChart').getContext('2d');
            const salesSummaryBody = document.getElementById('sales-summary-body');
            const salesSummaryFooter = document.getElementById('sales-summary-footer');
            const confirmModal = document.getElementById('custom-confirm-modal');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const modalText = document.getElementById('modal-text');

            // --- å‡½å¼å®šç¾© ---

            function initializeSalesData() {
                salesData = {};
                menuItems.forEach(item => {
                    salesData[item.name] = { quantity: 0, revenue: 0 };
                });
            }

            function renderCharts() {
                const labels = menuItems.map(item => item.name);
                const quantityData = labels.map(label => salesData[label] ? salesData[label].quantity : 0);
                const revenueData = labels.map(label => salesData[label] ? salesData[label].revenue : 0);

                if (quantityChartInstance) quantityChartInstance.destroy();
                quantityChartInstance = new Chart(quantityChartCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'éŠ·å”®æ•¸é‡',
                            data: quantityData,
                            backgroundColor: 'rgba(59, 130, 246, 0.5)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
                });

                if (revenueChartInstance) revenueChartInstance.destroy();
                revenueChartInstance = new Chart(revenueChartCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'éŠ·å”®é‡‘é¡ (NT$)',
                            data: revenueData,
                            backgroundColor: 'rgba(16, 185, 129, 0.5)',
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: { scales: { y: { beginAtZero: true } } }
                });
            }

            function renderSalesSummaryTable() {
                salesSummaryBody.innerHTML = '';
                let totalDailyRevenue = 0;

                menuItems.forEach(item => {
                    const itemName = item.name;
                    const data = salesData[itemName] || { quantity: 0, revenue: 0 };
                    totalDailyRevenue += data.revenue;
                    const rowHTML = `
                        <tr class="hover:bg-gray-50">
                            <td class="py-2 px-3 sm:py-3 sm:px-5 border-b">${itemName}</td>
                            <td class="py-2 px-3 sm:py-3 sm:px-5 border-b">${data.quantity}</td>
                            <td class="py-2 px-3 sm:py-3 sm:px-5 border-b">${data.revenue}</td>
                        </tr>
                    `;
                    salesSummaryBody.insertAdjacentHTML('beforeend', rowHTML);
                });

                salesSummaryFooter.innerHTML = `
                    <tr class="bg-gray-100 font-bold">
                        <td class="py-3 px-4 sm:py-4 sm:px-5" colspan="2">ç•¶æ—¥ç¸½é‡‘é¡</td>
                        <td class="py-3 px-4 sm:py-4 sm:px-5">${totalDailyRevenue}</td>
                    </tr>
                `;
            }
            
            function renderMenuItemsAndSubmit() {
                itemsContainer.innerHTML = '';
                
                menuItems.forEach(itemData => {
                    const itemHTML = `
                        <div class="item relative flex flex-col items-center justify-around bg-white p-2 rounded-lg transition-all duration-200 h-28 sm:h-32 cursor-pointer border-2 border-transparent shadow-md hover:shadow-lg" data-id="${itemData.id}" data-price="${itemData.price}" data-name="${itemData.name}">
                            <div class="text-center">
                                <span class="text-2xl sm:text-3xl">${itemData.emoji}</span>
                                <p class="text-sm sm:text-base font-semibold text-gray-800 leading-tight mt-1">${itemData.name}</p>
                                <p class="text-sm sm:text-base text-gray-500">NT$ ${itemData.price}</p>
                            </div>
                            <div>
                                <span class="quantity text-lg sm:text-xl font-semibold text-gray-900 w-8 sm:w-10 text-center">0</span>
                            </div>
                            <button class="minus-btn absolute bottom-1.5 right-1.5 bg-red-500 text-white rounded-full w-6 h-6 sm:w-7 sm:h-7 flex items-center justify-center text-lg sm:text-xl font-bold shadow-md hover:bg-red-600 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-red-400 disabled-btn">-</button>
                        </div>
                    `;
                    itemsContainer.insertAdjacentHTML('beforeend', itemHTML);
                });

                const resetBtnHTML = `
                    <div id="reset-btn" class="flex flex-col items-center justify-around bg-green-500 p-2 rounded-lg transition-all duration-200 h-28 sm:h-32 cursor-pointer shadow-md hover:bg-green-600 text-white">
                        <span class="text-2xl sm:text-3xl">ğŸ›’</span>
                        <p class="text-base sm:text-lg font-semibold mt-2 leading-tight">é€å‡ºè¨‚å–®</p>
                    </div>
                `;
                itemsContainer.insertAdjacentHTML('beforeend', resetBtnHTML);
            }

            function updateTotal() {
                let currentTotal = 0;
                const items = document.querySelectorAll('.item'); 
                
                items.forEach(item => {
                    const price = parseInt(item.dataset.price);
                    const quantity = parseInt(item.querySelector('.quantity').textContent);
                    currentTotal += price * quantity;
                    const minusBtn = item.querySelector('.minus-btn');
                    if (quantity > 0) {
                        item.classList.add('item-selected');
                        minusBtn.classList.remove('disabled-btn');
                    } else {
                        item.classList.remove('item-selected');
                        minusBtn.classList.add('disabled-btn');
                    }
                });
                
                totalPriceEl.textContent = 'NT$ ' + currentTotal;
                return currentTotal;
            }
            
            function exportSalesSummaryToExcel() {
                let totalDailyRevenue = 0;
                const summaryData = [['å•†å“', 'ç¸½æ•¸é‡', 'ç¸½é‡‘é¡ (NT$)']];
                menuItems.forEach(item => {
                    const itemName = item.name;
                    const data = salesData[itemName] || { quantity: 0, revenue: 0 };
                    totalDailyRevenue += data.revenue;
                    summaryData.push([itemName, data.quantity, data.revenue]);
                });
                summaryData.push([]);
                summaryData.push(['ç•¶æ—¥ç¸½é‡‘é¡', '', totalDailyRevenue]);
                const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, wsSummary, 'éŠ·å”®ç¸½è¡¨');
                const today = new Date();
                const dateString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                const timeString = `${String(today.getHours()).padStart(2, '0')}-${String(today.getMinutes()).padStart(2, '0')}-${String(today.getSeconds()).padStart(2, '0')}`;
                const filename = `éŠ·å”®ç¸½è¡¨_å‚™ä»½_${dateString}_${timeString}.xlsx`;
                XLSX.writeFile(wb, filename);
            }

            function renderOrderLog() {
                orderLogBody.innerHTML = '';
                paginationControls.innerHTML = '';

                if (allOrders.length === 0) return;

                const startIndex = (currentPage - 1) * ordersPerPage;
                const endIndex = startIndex + ordersPerPage;
                const currentOrders = allOrders.slice(startIndex, endIndex);

                currentOrders.forEach(order => {
                    const newRowHTML = `
                        <tr class="hover:bg-gray-50">
                            <td class="py-2 px-3 sm:py-3 sm:px-5 border-b">${order.id}</td>
                            <td class="py-2 px-3 sm:py-3 sm:px-5 border-b">${order.itemsHTML}</td>
                            <td class="py-2 px-3 sm:py-3 sm:px-5 border-b">NT$ ${order.total}</td>
                            <td class="py-2 px-3 sm:py-3 sm:px-5 border-b text-sm sm:text-base text-gray-500">${order.timestamp}</td>
                        </tr>
                    `;
                    orderLogBody.insertAdjacentHTML('beforeend', newRowHTML);
                });

                renderPagination();
            }

            function renderPagination() {
                const totalPages = Math.ceil(allOrders.length / ordersPerPage);
                if (totalPages <= 1) return;

                let paginationHTML = '';
                const prevDisabled = currentPage === 1 ? 'disabled-btn' : '';
                paginationHTML += `<button id="prev-page-btn" class="bg-blue-500 text-white px-4 py-2 sm:px-6 sm:py-3 rounded-lg text-lg sm:text-xl font-bold hover:bg-blue-600 transition-all ${prevDisabled}">ä¸Šä¸€é </button>`;
                
                paginationHTML += `<span class="font-semibold text-gray-700 text-xl sm:text-2xl">ç¬¬ ${currentPage} / ${totalPages} é </span>`;

                const nextDisabled = currentPage === totalPages ? 'disabled-btn' : '';
                paginationHTML += `<button id="next-page-btn" class="bg-blue-500 text-white px-4 py-2 sm:px-6 sm:py-3 rounded-lg text-lg sm:text-xl font-bold hover:bg-blue-600 transition-all ${nextDisabled}">ä¸‹ä¸€é </button>`;
                
                paginationControls.innerHTML = paginationHTML;
            }

            function logOrder() {
                const currentTotal = updateTotal();
                if (currentTotal === 0) return;

                const items = document.querySelectorAll('.item');
                let itemSummary = [];
                items.forEach(item => {
                    const quantity = parseInt(item.querySelector('.quantity').textContent);
                    if (quantity > 0) {
                        const name = item.dataset.name;
                        const price = parseInt(item.dataset.price);
                        itemSummary.push(`${name} x ${quantity}`);
                        salesData[name].quantity += quantity;
                        salesData[name].revenue += quantity * price;
                    }
                });

                const newOrder = {
                    id: orderCounter,
                    itemsHTML: itemSummary.join('<br>'),
                    total: currentTotal,
                    timestamp: new Date().toLocaleString('zh-TW', { hour12: false })
                };

                allOrders.unshift(newOrder);
                orderCounter++;
                
                currentPage = 1;
                renderOrderLog();
                saveDataToLocalStorage();
                renderCharts();
                renderSalesSummaryTable();

                document.querySelectorAll('.quantity').forEach(q => q.textContent = '0');
                updateTotal();
            }

            function saveDataToLocalStorage() {
                localStorage.setItem('posSalesData', JSON.stringify(salesData));
                localStorage.setItem('posOrderCounter', orderCounter.toString());
                localStorage.setItem('posAllOrders', JSON.stringify(allOrders));
            }

            function loadDataFromLocalStorage() {
                const savedSalesData = localStorage.getItem('posSalesData');
                if (savedSalesData) salesData = JSON.parse(savedSalesData);
                else initializeSalesData();

                const savedOrderCounter = localStorage.getItem('posOrderCounter');
                if (savedOrderCounter) orderCounter = parseInt(savedOrderCounter, 10);
                
                const savedOrders = localStorage.getItem('posAllOrders');
                if (savedOrders) allOrders = JSON.parse(savedOrders);
            }

            function clearAllData() {
                localStorage.removeItem('posSalesData');
                localStorage.removeItem('posOrderCounter');
                localStorage.removeItem('posAllOrders');
                allOrders = [];
                orderCounter = 1;
                currentPage = 1;
                initializeSalesData();
                renderOrderLog();
                renderCharts();
                renderSalesSummaryTable();
            }
            
            function showConfirmModal() {
                confirmModal.classList.remove('hidden');
            }

            function hideConfirmModal() {
                confirmModal.classList.add('hidden');
            }

            function setupEventListeners() {
                itemsContainer.addEventListener('click', (e) => {
                    const item = e.target.closest('.item');
                    const resetButton = e.target.closest('#reset-btn');

                    if (resetButton) {
                        logOrder();
                        resetButton.classList.add('btn-press');
                        setTimeout(() => resetButton.classList.remove('btn-press'), 100);
                        return;
                    }

                    if (!item) return;

                    const minusBtn = e.target.closest('.minus-btn');
                    const quantityEl = item.querySelector('.quantity');
                    let quantity = parseInt(quantityEl.textContent);

                    if (minusBtn) {
                        if (quantity > 0) quantity--;
                        minusBtn.classList.add('btn-press');
                        setTimeout(() => minusBtn.classList.remove('btn-press'), 100);
                    } else {
                        quantity++;
                        item.classList.add('btn-press');
                        setTimeout(() => item.classList.remove('btn-press'), 100);
                    }
                    quantityEl.textContent = quantity;
                    updateTotal();
                });

                clearLogBtn.addEventListener('click', () => {
                    const hasSales = Object.values(salesData).some(item => item.quantity > 0);
                    if (hasSales) {
                        exportSalesSummaryToExcel();
                        modalText.textContent = 'è³‡æ–™å·²æˆåŠŸå‚™ä»½ç‚º Excel æª”æ¡ˆã€‚æ‚¨ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚';
                    } else {
                        modalText.textContent = 'ç›®å‰æ²’æœ‰ä»»ä½•è³‡æ–™å¯å‚™ä»½ã€‚æ‚¨ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚';
                    }
                    showConfirmModal();
                });

                paginationControls.addEventListener('click', (e) => {
                    if (e.target.id === 'prev-page-btn' && currentPage > 1) {
                        currentPage--;
                        renderOrderLog();
                    }
                    if (e.target.id === 'next-page-btn' && currentPage < Math.ceil(allOrders.length / ordersPerPage)) {
                        currentPage++;
                        renderOrderLog();
                    }
                });

                modalConfirmBtn.addEventListener('click', () => {
                    clearAllData();
                    hideConfirmModal();
                    clearLogBtn.classList.add('btn-press');
                    setTimeout(() => clearLogBtn.classList.remove('btn-press'), 100);
                });

                modalCancelBtn.addEventListener('click', () => {
                    hideConfirmModal();
                });
            }

            // --- åˆå§‹åŒ– ---
            loadDataFromLocalStorage();
            renderMenuItemsAndSubmit();
            updateTotal();
            renderOrderLog();
            renderCharts();
            renderSalesSummaryTable();
            setupEventListeners(); 
        });

        // --- Service Worker for Offline Capability ---
        if ('serviceWorker' in navigator) {
            const swJS = `
                const CACHE_NAME = 'pos-system-cache-v1';
                const urlsToCache = [
                    '/',
                    'https://cdn.tailwindcss.com',
                    'https://cdn.jsdelivr.net/npm/chart.js',
                    'https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js',
                    'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+TC:wght@400;500;700&display=swap',
                    'https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7.woff2',
                    'https://fonts.gstatic.com/s/notosanstc/v40/TuGOUg-eNqGYqsN7UYEwBx_C-j2f-EzhbqE.woff2'
                ];
                self.addEventListener('install', event => {
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                            .then(cache => {
                                console.log('Opened cache');
                                const requests = urlsToCache.map(url => new Request(url, { mode: 'no-cors' }));
                                return cache.addAll(requests);
                            })
                    );
                });
                self.addEventListener('fetch', event => {
                    event.respondWith(
                        caches.match(event.request)
                            .then(response => {
                                if (response) return response;
                                return fetch(event.request).catch(() => caches.match('/'));
                            })
                    );
                });
            `;
            const blob = new Blob([swJS], { type: 'application/javascript' });
            const swURL = URL.createObjectURL(blob);
            window.addEventListener('load', () => {
                navigator.serviceWorker.register(swURL)
                    .then(reg => console.log('ServiceWorker registration successful: ', reg.scope))
                    .catch(err => console.log('ServiceWorker registration failed: ', err));
            });
        }
    </script>
</body>
</html>

